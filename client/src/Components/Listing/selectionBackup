import React, { useContext, useEffect, useState } from "react";
import axios from "axios";
import { ListingContext } from "../../Context/listing-context.jsx";
import "../Cards/Cards.css";
import "./Selecting.css";
import Modal from "../../Components/Modal/Modal";
import Modal2 from "../Modal/Modal2";

export const Listing = () => {
  const { showModal, showModal2, selectRoommateDetail, selectRoomDetail } =
    useContext(ListingContext);

  const profileData = JSON.parse(localStorage.getItem("profile"));

  const [following, setFollowing] = useState([]);
  const [likeRoom, setLikeRoom] = useState([]);
  const [roommatePosts, setRoommatePosts] = useState([]);
  const [roomPosts, setRoomPosts] = useState([]);
  const [matchingRoommateData, setMatchingRoommateData] = useState([]);
  const [matchingRoomData, setMatchingRoomData] = useState([]);

  const [isLoading, setIsLoading] = useState(true);

  // Fetch following and likeRoom data when the component mounts
  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await axios.get(
          `https://roommate-finder-theta.vercel.app/user/${profileData.user._id}`
        );

        console.log("Profile fetched:", response.data);
        const followingUserIds = response.data.likesRoommate;
        const likeRoomIds = response.data.likesRoom;

        setFollowing(followingUserIds);
        setLikeRoom(likeRoomIds);

        console.log("Following fetched:", followingUserIds, likeRoomIds);
      } catch (error) {
        console.error("Error fetching profile:", error);
      }
    };

    fetchData();
  }, [profileData.user._id]);

  // Fetch roommate and room data when the component mounts
  useEffect(() => {
    const fetchRoommateData = async () => {
      try {
        const response = await axios.get(
          "https://roommate-finder-theta.vercel.app/roommate/all"
        );

        const roommatePostsWithUserDetailsPromises = response.data.map(
          async (post) => {
            const userResponse = await axios.get(
              `https://roommate-finder-theta.vercel.app/user/${post.userId}`
            );

            const userDetails = userResponse.data;
            return {
              ...post,
              userDetails,
            };
          }
        );

        const roommatePostsWithUserDetails = await Promise.all(
          roommatePostsWithUserDetailsPromises
        );

        setRoommatePosts(roommatePostsWithUserDetails);

        // Compare the data and store matching data in matchingRoommateData
        const matchingData = roommatePostsWithUserDetails.filter((post) =>
          following.includes(post._id)
        );
        setMatchingRoommateData(matchingData);
      } catch (error) {
        console.error(error);
      }
    };

    const fetchRoomData = async () => {
      try {
        const response = await axios.get(
          "https://roommate-finder-theta.vercel.app/room/all"
        );

        const roomPostsWithUserDetailsPromises = response.data.map(
          async (post) => {
            const userResponse = await axios.get(
              `https://roommate-finder-theta.vercel.app/user/${post.userId}`
            );

            const userDetails = userResponse.data;
            return {
              ...post,
              userDetails,
            };
          }
        );

        const roomPostsWithUserDetails = await Promise.all(
          roomPostsWithUserDetailsPromises
        );

        setRoomPosts(roomPostsWithUserDetails);

        const matchingData2 = roomPostsWithUserDetails.filter((post) =>
          likeRoom.includes(post._id)
        );
        setMatchingRoomData(matchingData2);
      } catch (error) {
        console.error(error);
      }
    };

    fetchRoommateData();
    fetchRoomData();
    setIsLoading(false);
  }, [following, likeRoom]);

  console.log("Following:", following);
  console.log("Like Room:", likeRoom);
  console.log("Roommate Posts:", matchingRoommateData);
  console.log("MatchingRoom Posts:", matchingRoomData);

  return (
    <div className="listing">
      <div className="listing-buttons">
        <button className="activelisting">
          <p className="listing-text">Your Selections</p>
        </button>
      </div>
      <div className="profiletab-hr">
        <hr />
      </div>
      <div className="tab-content">
        {isLoading ? ( // Check if isLoading is true, show a loading message
          <p>Loading...</p>
        ) : (
          <div>
            {showModal && <Modal />}
            <div className="cards">
              {matchingRoommateData.map((item) => (
                <div className="each-card">
                  <span className="cards">
                    <div className="main-card">
                      <div className="card-details">
                        <div className="card-img"></div>
                        <div className="card-info">
                          <div className="card-informatios">
                            <div className="card-name">
                              {item.userDetails.firstname ?? "Null_Fname"}{" "}
                              {item.userDetails.lastname ?? "Null_Lname"}
                            </div>
                            <div className="card-add">
                              <img
                                src="./image/add-icon.png"
                                alt=""
                                style={{ height: "24px", width: "24px" }}
                              />
                            </div>
                          </div>
                          <div className="card-preference">
                            <div className="card-rank">
                              <div className="card-preference-title">Rank</div>
                              <div className="card-preference-content">
                                {" "}
                                {item.rank}
                              </div>
                            </div>
                            <div className="card-block">
                              <div className="card-preference-title">
                                Prefered Block
                              </div>
                              <div className="card-preference-content">
                                {" "}
                                {item.preferredBlock}
                              </div>
                            </div>
                            <div className="card-bed">
                              <div className="card-preference-title">
                                Prefered Bed Type
                              </div>
                              <div className="card-preference-content">
                                {" "}
                                {item.preferredBed}
                              </div>
                            </div>
                          </div>
                          <div className="card-downers">
                            <div className="card-year">
                              <div className="card-preference-title">Year</div>
                              <div className="card-preference-Year">year</div>
                            </div>
                            <div className="card-gender">
                              <div className="card-preference-title">
                                Gender
                              </div>
                              <div className="card-preference-Gender">
                                {" "}
                                {item.gender}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div className="card-hr">
                        <hr />
                      </div>
                      <div className="card-habits-section">
                        <div className="card-habit">Habits</div>
                        <div
                          className="card-habit-details"
                          onClick={() => selectRoommateDetail(item.desc)}
                        >
                          <div>
                            <img
                              src="./image/desc.png"
                              alt=""
                              style={{ height: "18px", width: "18px" }}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </span>
                </div>
              ))}

              {showModal2 && <Modal2 />}

              {matchingRoomData.map((item) => (
                <div div className="each-card">
                  <span className="cards">
                    <div className="main-card">
                      <div className="card-details">
                        <div className="card-img"></div>
                        <div className="card-info">
                          <div className="card-informatios">
                            <div className="card-name">
                              {item.preferredBlock}
                            </div>
                            <div className="card-add">
                              <img
                                src="./image/add-icon.png"
                                alt=""
                                style={{ height: "24px", width: "24px" }}
                              />
                            </div>
                          </div>
                          <div className="card-preference">
                            <div className="card-rank">
                              <div className="card-preference-title">Rank</div>
                              <div className="card-preference-content">
                                {item.rank}
                              </div>
                            </div>
                            <div className="card-block">
                              <div className="card-preference-title">
                                Prefered Bed
                              </div>
                              <div className="card-preference-content">
                                {item.preferredBed}
                              </div>
                            </div>
                            <div className="card-bed">
                              <div className="card-preference-title">
                                Remaining
                              </div>
                              <div className="card-preference-content">
                                remaining
                              </div>
                            </div>
                          </div>
                          <div className="card-downers2">
                            <div className="card-year">
                              <div className="card-preference-title">Year</div>
                              <div className="card-preference-Year">year</div>
                            </div>
                            <div className="card-gender">
                              <div className="card-preference-title">
                                Gender
                              </div>
                              <div className="card-preference-Gender">
                                {item.gender}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div className="card-hr">
                        <hr />
                      </div>
                      <div className="card-habits-section">
                        <div className="card-habit">Leader</div>
                        <div
                          className="card-habit-details"
                          onClick={() => selectRoomDetail(item.desc)}
                        >
                          <div>
                            <img
                              src="./image/desc.png"
                              alt=""
                              style={{ height: "18px", width: "18px" }}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};
